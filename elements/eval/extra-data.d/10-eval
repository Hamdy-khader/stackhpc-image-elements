#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

for value in $(compgen -v); do
    if [[ "$value" == DIB_EVAL_* ]]; then
        script="${!value}"
        ref="${value#DIB_EVAL_}"
        # grab metadata from:
        # DIB_METAEVAL_NAME: name of the script
        # DIB_METAVAL_HOOK: directory where the hook is installed
        name_ref="DIB_METAEVAL_""$ref""_NAME"
        hook_ref="DIB_METAEVAL_""$ref""_HOOK"
        name="${!name_ref}"
        hook="${!hook_ref}"
        if [ -z "$name" ]; then
            die "you must set $name_ref"
        fi
        if [ -z "$hook" ]; then
            die "you must set $hook_ref"
        fi
        test -d "$TMP_HOOKS_PATH/$hook" || mkdir -p "$TMP_HOOKS_PATH/$hook"
        echo "$script" > "$TMP_HOOKS_PATH/$hook/$name"
        chmod +x "$TMP_HOOKS_PATH/$hook/$name"
    fi
done

